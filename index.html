<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">3</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
        <li class="comment">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button class="like-button -active-like"></button>
            </div>
          </div>
        </li>
      </ul>
      <div class="add-form">
        <div id="quote-indicator" style="display: none; margin-bottom: 10px; padding: 5px; background: #f0f0f0; border-radius: 4px; font-size: 14px;"></div>
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
   "use strict";
    const formNameEl = document.querySelector('.add-form-name');
    const formCommentEl = document.querySelector('.add-form-text');
    const buttonEl = document.querySelector('.add-form-button');
    const quoteIndicatorEl = document.getElementById('quote-indicator');

    const commentsListEl = document.querySelector('.comments');

    // Переменная для хранения информации о цитируемом комментарии
    let quotedComment = null;

    // Добавляем массив для хранения состояния комментариев
    let comments = [
      {
        name: "Глеб Фокин",
        date: "12.02.22 12:18",
        text: "Это будет первый комментарий на этой странице",
        likes: 3,
        isLiked: false
      },
      {
        name: "Варвара Н.",
        date: "13.02.22 19:22",
        text: "Мне нравится как оформлена эта страница! ❤",
        likes: 75,
        isLiked: true
      }
    ];

    // Функция для экранирования HTML
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function getCurrentDateTime() {
      const now = new Date();

      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = String(now.getFullYear()).slice(-2);
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    }

    // Функция для рендера комментариев
    function renderComments() {
      commentsListEl.innerHTML = '';
      
      comments.forEach((comment, index) => {
        const likeClass = comment.isLiked ? ' -active-like' : '';
        
        const commentHTML = `
          <li class="comment" data-index="${index}">
            <div class="comment-header">
              <div>${escapeHtml(comment.name)}</div>
              <div>${comment.date}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">
                ${comment.text} <!-- Убрано escapeHtml, так как текст уже безопасен -->
              </div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${comment.likes}</span>
                <button class="like-button${likeClass}"></button>
              </div>
            </div>
          </li>
        `;
        
        commentsListEl.innerHTML += commentHTML;
      });
      
      // Добавляем обработчики клика на комментарии и лайки после рендера
      addCommentListeners();
      addLikeListeners();
    }

    // Функция для добавления обработчиков на комментарии
    function addCommentListeners() {
      const commentElements = document.querySelectorAll('.comment');
      
      commentElements.forEach((commentEl) => {
        commentEl.addEventListener('click', (event) => {
          // Проверяем, был ли клик на кнопке лайка
          if (event.target.closest('.like-button')) {
            return; // Прерываем выполнение, если клик был на лайке
          }
          
          const index = parseInt(commentEl.dataset.index);
          const comment = comments[index];
          
          // Устанавливаем имя автора в поле ввода
          formNameEl.value = comment.name;
          
          // Добавляем текст комментария с символом ">" перед каждой строкой
          const quotedText = `> ${comment.text.replaceAll('\n', '\n> ')}\n\n`;
          formCommentEl.value = quotedText;
          
          // Сохраняем информацию о цитируемом комментарии
          quotedComment = {
            index: index,
            name: comment.name,
            text: comment.text
          };
          
          // Показываем индикатор цитирования
          quoteIndicatorEl.textContent = `Ответ на комментарий ${escapeHtml(comment.name)}`;
          quoteIndicatorEl.style.display = 'block';
          
          // Фокусируемся на поле ввода комментария
          formCommentEl.focus();
        });
      });
    }

    // Функция для добавления обработчиков на кнопки лайков
    function addLikeListeners() {
      const likeButtons = document.querySelectorAll('.like-button');
      
      likeButtons.forEach((button, index) => {
        button.addEventListener('click', (event) => {
          // Останавливаем всплытие события, чтобы не сработал обработчик комментария
          event.stopPropagation();
          
          // Меняем состояние лайка в массиве
          if (comments[index].isLiked) {
            comments[index].likes--;
            comments[index].isLiked = false;
          } else {
            comments[index].likes++;
            comments[index].isLiked = true;
          }
          
          // Перерендериваем комментарии
          renderComments();
        });
      });
    }

    buttonEl.addEventListener('click', () => {
      const name = formNameEl.value.trim();
      let commentText = formCommentEl.value.trim();
      
      if (!name || !commentText) {
        alert('Пожалуйста, заполните все поля');
        return;
      }

      // Экранируем только имя пользователя (текст комментария оставляем как есть)
      const safeName = escapeHtml(name);
      
      // Сохраняем текст комментария без экранирования, так как он уже безопасен
      // (пользователь не может вставить HTML через текстовое поле)
      
      // Добавляем новый комментарий в массив
      comments.push({
        name: safeName,
        date: getCurrentDateTime(),
        text: commentText, // Сохраняем как есть, без экранирования
        likes: 0,
        isLiked: false
      });
      
      // Перерендериваем все комментарии
      renderComments();
      
      // Очищаем форму и сбрасываем цитирование
      formNameEl.value = '';
      formCommentEl.value = '';
      quotedComment = null;
      quoteIndicatorEl.style.display = 'none';
    });
    
    formNameEl.addEventListener('input', () => {
      console.log('Имя изменено:', formNameEl.value);
    });
    
    formCommentEl.addEventListener('input', () => {
      console.log('Комментарий изменен:', formCommentEl.value);
    });

    // Инициализируем рендер при загрузке страницы
    renderComments();
    //Выводим в консоль
    console.log("It works!");
  </script>
</html>